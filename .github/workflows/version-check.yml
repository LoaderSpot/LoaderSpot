name: Version Check
on:
  repository_dispatch:
    types: [webhook-event]
    
concurrency:
  group: delayed-version-check
  cancel-in-progress: false    

jobs:
  version-search:
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.search.outputs.versions }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Download latest loaderspot_cli_linux_x64
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download --repo ${{ github.repository }} --pattern "loaderspot-cli-linux-x64" --output loaderspot_cli
          chmod +x loaderspot_cli

      - name: Version search
        id: search
        if: github.event.client_payload.v && github.event.client_payload.s
        env:
          v: ${{ github.event.client_payload.v }}
          s: ${{ github.event.client_payload.s }}
        run: |
          {
            echo 'versions<<EOF'
            ./loaderspot_cli --version "$v" --connections 300 --ladder-search
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

  get-build-and-send:
    runs-on: windows-latest
    needs: version-search
    if: success() && needs.version-search.outputs.versions
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Get build type and send to GAS
        shell: pwsh
        env:
          GOOGLE_APPS_URL: ${{ secrets.GOOGLE_APPS_URL }}
          versions: ${{ needs.version-search.outputs.versions }}
          source: ${{ github.event.client_payload.s }}
        run: |
          # –ü–æ–ª—É—á–∞–µ–º build type
          $versionsJson = $env:versions | ConvertFrom-Json
          $win64Url = $versionsJson.WIN64
          
          if ($win64Url) {
            ./get-build-info.ps1 -Url $win64Url
            $buildType = (Get-Content $env:GITHUB_OUTPUT | Select-String "build_type=(.+)" | ForEach-Object { $_.Matches.Groups[1].Value })
          } else {
            $buildType = "false"
          }
          
          Write-Host "üîß Build Type: $buildType"
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π JSON
          $versionsObj = $env:versions | ConvertFrom-Json
          
          if ($buildType -eq "false") {
            $versionsObj | Add-Member -NotePropertyName "buildType" -NotePropertyValue $false -Force
          } else {
            $versionsObj | Add-Member -NotePropertyName "buildType" -NotePropertyValue $buildType -Force
          }
          
          $versionsObj | Add-Member -NotePropertyName "source" -NotePropertyValue $env:source -Force
          
          $finalJson = $versionsObj | ConvertTo-Json -Compress
          
          Write-Host "–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ GAS..."
          Write-Host "–í–µ—Ä—Å–∏—è: $($versionsObj.version)"
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ GAS —á–µ—Ä–µ–∑ PowerShell
          try {
            $response = Invoke-WebRequest -Uri $env:GOOGLE_APPS_URL `
              -Method POST `
              -ContentType "application/json" `
              -Body $finalJson `
              -UseBasicParsing
            
            Write-Host "–û—Ç–≤–µ—Ç –æ—Ç GAS: $($response.Content)"
          } catch {
            Write-Host "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≤ GAS: $_"
            exit 1
          }